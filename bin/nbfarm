#!/bin/sh
#
# File:   nbfarm
#
# Title:  NodeBrain Compile Farm Driver Script
#
# Function:
#
#   This script is used to automate the process of testing
#   source release files on a set of servers in a compiler
#   farm. It runs on a single server in the farm and remotely
#   invokes a common process in each pen (compiler server).
#
# Synopsis:
#
#   [PEN=<pen>] nbfarm <option> <release> [<you>]
#
#     <pen>      - file expression to select specific pens
#
#     <option>   - option to pass on to nbpen---see nbpen
#                  for a description of these options.
#
#     <release>  - release number (e.g. nb-0.6.1)
#
#     <you>      - email address where results are reported
#
# Example:
#
#   1) Build in all pens and report results
#
#      ./nbfarm build nb-0.6.1 eat@nodebrain.org
#
#   2) Build and package in all pens without reporting results
#
#      ./nbfarm package nb-0.6.1  
#
#   3) Verify in solaris pens and report results 
#
#      PEN="*solaris*" ./nbfarm verify nb-0.6.1 eat@nodebrain.org
#
# Description
#
#   A farm is defined by a farm directory.  A subdirectory is provided
#   for each pen (compiler server).
#
#      nodebrain/farm/<pen>/
# 
#   The name of each pen is a host name of a compiler server.  The
#   nbfarm script reads the farm directory and remotely invokes nbpen
#   (using ssh) for each selected pen.  The compiler server works in
#   the assigned pen directory, which may be shared via NFS.
#
#   Each compiler server works in a directory constructed for the release
#   we are testing. This enable concurrent testing of multiple releases. 
#
#      nodebrain/farm/<pen>/<release>/
#
#   The output of nbpen is written to the out directory. When a shared
#   file system is used, this makes it easy to review the output of all
#   builds.
#
#      nodebrain/out/<release>-<pen>-nbpen.out 
#
#   When an email address is specified, the last 20 lines of the output
#   file is mailed to the addresses provided (you).
#
#   Binary distributions are written to the dist directory.
#
#      nodebrain/dist/<release>-<pen>.tar.gz
#
#=======================================================================
#set -x

opt=$1
rel=$2
you=$3
pat=${PEN-"*"}
mode=${MODE}

if test "x$rel" = "x"; then
  echo "usage:   [PEN=<pen>] ./nbfarm <option> <release> [<your_email_address>]\n"
  echo "Example: ./nbfarm package nb-0.6.1"
  echo "         ./nbfarm compile nb-0.6.1 me@myplace.org"
  echo "         PEN="*solaris*" ./nbfarm verify nb-0.6.1 me@myplace.org"
  exit 1
  fi

echo "mode=${mode} option=${opt} release=${rel}"

cd farm
for pen in ${pat}; do
  echo "Pen ${pen}"
  if test "x$you" = "x"; then
    cmd="./nbpen ${opt} ${rel} ${pen} > out/${rel}-${pen}-nbpen.out 2>&1 &"
  else
    cmd="./nbpen ${opt} ${rel} ${pen} | tail -30 | mail -s \"nodebrain ${rel}-${pen} status\" ${you} &"
#    cmd="echo \"hello world\" | tail -30 | mail -s \"nodebrain ${rel}-${pen} status\" ${you} &"
    fi
  echo "Command: $cmd"
  if test "x$mode" = "xlocal"; then
    cd ..
    sh -c "${cmd}"
    cd farm
  else
    ssh ${pen} "cd nodebrain; ${cmd}"
    fi
  done
